@model MyDictionary.Core.Entities.Word
@using MyDictionary.Core.Entities

@{
    ViewData["Title"] = "Add Word";
}

<div class="max-w-2xl mx-auto">
    <div class="mb-8">
        <a asp-action="Index" class="text-slate-500 hover:text-slate-700 text-sm font-medium mb-2 inline-block">
            <i class="fa-solid fa-arrow-left mr-1"></i> Back to List
        </a>
        <h1 class="text-2xl font-bold text-slate-900">Add New Word</h1>
        <p class="text-slate-500">Add a new word to your vocabulary collection</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 md:p-8">
        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-red-600 mb-4 text-sm"></div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Word Input -->
                <div class="col-span-2">
                    <label asp-for="WordText" class="block text-sm font-medium text-slate-700 mb-1">Word / Phrase</label>
                    <div class="relative">
                        <input asp-for="WordText" class="w-full pl-4 pr-12 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Enter word..." />
                        <button type="button" id="btnTranslate" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary-600 p-1" title="Auto Translate">
                            <i class="fa-solid fa-language"></i>
                        </button>
                    </div>
                    <span asp-validation-for="WordText" class="text-red-600 text-xs mt-1"></span>
                </div>

                <!-- Translation Input -->
                <div class="col-span-2">
                    <label asp-for="Translation" class="block text-sm font-medium text-slate-700 mb-1">Translation</label>
                    <input asp-for="Translation" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Translation..." />
                    <span asp-validation-for="Translation" class="text-red-600 text-xs mt-1"></span>
                </div>

                <!-- Languages -->
                <div>
                    <label asp-for="LanguageFrom" class="block text-sm font-medium text-slate-700 mb-1">From Language</label>
                    <select asp-for="LanguageFrom" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="en">English</option>
                        <option value="ar">Arabic</option>
                        <option value="fr">French</option>
                        <option value="es">Spanish</option>
                        <option value="de">German</option>
                    </select>
                </div>
                <div>
                    <label asp-for="LanguageTo" class="block text-sm font-medium text-slate-700 mb-1">To Language</label>
                    <select asp-for="LanguageTo" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="ar">Arabic</option>
                        <option value="en">English</option>
                        <option value="fr">French</option>
                        <option value="es">Spanish</option>
                        <option value="de">German</option>
                    </select>
                </div>

                <!-- Part of Speech -->
                <div>
                    <label asp-for="PartOfSpeech" class="block text-sm font-medium text-slate-700 mb-1">Part of Speech</label>
                    <select asp-for="PartOfSpeech" asp-items="Html.GetEnumSelectList<PartOfSpeech>()" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-primary-500"></select>
                </div>

                <!-- Difficulty -->
                <div>
                    <label asp-for="Difficulty" class="block text-sm font-medium text-slate-700 mb-1">Initial Difficulty</label>
                    <select asp-for="Difficulty" asp-items="Html.GetEnumSelectList<Difficulty>()" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-primary-500"></select>
                </div>

                <!-- Example Sentence -->
                <div class="col-span-2">
                    <label asp-for="ExampleSentence" class="block text-sm font-medium text-slate-700 mb-1">Example Sentence (Optional)</label>
                    <div class="relative">
                        <textarea asp-for="ExampleSentence" id="ExampleSentence" rows="2" class="w-full px-4 py-2 pr-24 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"></textarea>
                        <div class="absolute right-2 top-2 flex gap-1">
                            <button type="button" id="btnPlaySentence" class="text-slate-400 hover:text-primary-600 p-1" title="Listen to sentence">
                                <i class="fa-solid fa-volume-high"></i>
                            </button>
                            <button type="button" id="btnGenerateExample" class="text-slate-400 hover:text-primary-600 p-1" title="Generate Example with AI">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sentence Translation (Auto-generated) -->
                <div class="col-span-2" id="sentenceTranslationContainer" style="display: none;">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Sentence Translation</label>
                    <div class="px-4 py-2 rounded-lg bg-slate-50 border border-slate-200 text-slate-600 italic" id="sentenceTranslation">
                        <!-- Translation will appear here -->
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="col-span-2">
                    <label asp-for="Notes" class="block text-sm font-medium text-slate-700 mb-1">Notes (Optional)</label>
                    <textarea asp-for="Notes" rows="2" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"></textarea>
                </div>
            </div>

            <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-100">
                <a asp-action="Index" class="px-4 py-2 text-sm font-medium text-slate-700 hover:text-slate-900 transition-colors">Cancel</a>
                <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm">
                    Save Word
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Auto-translate word when user leaves the WordText field
            $('#WordText').blur(function() {
                var text = $(this).val();
                var translation = $('#Translation').val();
                
                // Only auto-translate if translation is empty
                if(text && !translation) {
                    var from = $('#LanguageFrom').val();
                    var to = $('#LanguageTo').val();
                    
                    $.get('/Words/GetTranslation', { text: text, from: from, to: to }, function(data) {
                        $('#Translation').val(data.translation);
                    });
                }
            });

            // Manual translation button
            $('#btnTranslate').click(function() {
                var text = $('#WordText').val();
                var from = $('#LanguageFrom').val();
                var to = $('#LanguageTo').val();
                
                if(text) {
                    var btn = $(this);
                    btn.addClass('animate-spin');
                    
                    $.get('/Words/GetTranslation', { text: text, from: from, to: to }, function(data) {
                        $('#Translation').val(data.translation);
                        btn.removeClass('animate-spin');
                    }).fail(function() {
                        btn.removeClass('animate-spin');
                        alert('Translation failed. Please try again.');
                    });
                }
            });

            // Generate example sentence
            $('#btnGenerateExample').click(function() {
                var word = $('#WordText').val();
                var translation = $('#Translation').val();
                var partOfSpeech = $('#PartOfSpeech option:selected').text();
                var languageFrom = $('#LanguageFrom').val();
                var languageTo = $('#LanguageTo').val();
                
                if(!word) {
                    alert('Please enter a word first.');
                    return;
                }
                
                var btn = $(this);
                var icon = btn.find('i');
                icon.addClass('animate-spin');
                
                $.get('/Words/GenerateExample', { 
                    word: word, 
                    translation: translation,
                    partOfSpeech: partOfSpeech,
                    languageFrom: languageFrom,
                    languageTo: languageTo
                }, function(data) {
                    $('#ExampleSentence').val(data.example);
                    icon.removeClass('animate-spin');
                    
                    // Auto-translate the sentence
                    translateSentence(data.example, languageFrom, languageTo);
                }).fail(function() {
                    icon.removeClass('animate-spin');
                    alert('Failed to generate example. Please try again.');
                });
            });

            // Translate sentence when user types
            $('#ExampleSentence').on('input', debounce(function() {
                var sentence = $(this).val();
                if(sentence) {
                    var from = $('#LanguageFrom').val();
                    var to = $('#LanguageTo').val();
                    translateSentence(sentence, from, to);
                } else {
                    $('#sentenceTranslationContainer').hide();
                }
            }, 1000));

            // Play sentence audio
            $('#btnPlaySentence').click(function() {
                var sentence = $('#ExampleSentence').val();
                if(sentence) {
                    var utterance = new SpeechSynthesisUtterance(sentence);
                    utterance.lang = 'en-US'; // Always play in English
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('Please enter a sentence first.');
                }
            });

            function translateSentence(text, from, to) {
                $.get('/Words/GetTranslation', { text: text, from: from, to: to }, function(data) {
                    $('#sentenceTranslation').text(data.translation);
                    $('#sentenceTranslationContainer').show();
                });
            }

            // Debounce helper
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        });
    </script>
}
